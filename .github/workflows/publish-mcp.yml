name: Publish to MCP Registry

# Trigger after the NPM publish workflow completes to ensure ordering
on:
  workflow_run:
    workflows:
      - "Publish Packages to NPM Registry"
    types:
      - completed

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: "lts/*"

      - name: Install mcp-publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/').tar.gz" | tar xz mcp-publisher

      - name: Authenticate to MCP Registry (OIDC)
        run: |
          ./mcp-publisher login github-oidc

      - name: Set version in server.json (from triggering workflow_run)
        run: |
          # Try to read the tag/ref from the triggering workflow_run event
          TAG_REF=$(jq -r .workflow_run.head_branch < "$GITHUB_EVENT_PATH")
          if [ "$TAG_REF" = "null" ] || [ -z "$TAG_REF" ]; then
            TAG_REF=$(jq -r .workflow_run.head_ref < "$GITHUB_EVENT_PATH")
          fi
          # Normalize to version number (strip refs/tags/ and leading v)
          VERSION=${TAG_REF#refs/tags/}
          VERSION=${VERSION#v}
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "Could not determine version from workflow_run event; leaving server.json unchanged"
          else
            jq --arg v "$VERSION" '.version = $v | .packages[0].version = $v' packages/feishu-markdown-mcp/server.json > /tmp/server.json && mv /tmp/server.json packages/feishu-markdown-mcp/server.json
            echo "Set server.json version to $VERSION"
          fi

      - name: Publish to MCP Registry
        working-directory: packages/feishu-markdown-mcp
        run: |
          ../../mcp-publisher publish
